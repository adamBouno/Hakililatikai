{% extends "core/base.html" %}
{% load static %}
{% block title %}Centres de santé — Rassurez-moi{% endblock %}

{% block extra_css %}
<style>
  /* Section héros */
  .centres-hero {
    background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
    padding: 4rem 0 2rem 0;
    color: white;
    position: relative;
    overflow: hidden;
    text-align: center;
  }
  .centres-hero::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><defs><pattern id=\'medical-pattern\' width=\'20\' height=\'20\' patternUnits=\'userSpaceOnUse\'><circle cx=\'10\' cy=\'10\' r=\'1\' fill=\'white\' opacity=\'0.1\'/></pattern></defs><rect width=\'100\' height=\'100\' fill=\'url(%23medical-pattern)\'/></svg>');
    opacity: 0.2;
  }
  .centres-hero-content { position: relative; z-index: 2; }
  .centres-hero h1 { font-size: 3rem; font-weight: 800; margin-bottom: 1rem; }
  .centres-hero p { font-size: 1.2rem; opacity: 0.95; max-width: 600px; margin: 0 auto 1.5rem; }
  .centres-stats { display: flex; justify-content: center; gap: 2.5rem; margin-top: 2rem; }
  .centres-stat-number { font-size: 2.2rem; font-weight: 800; display: block; }
  .centres-stat-label { font-size: 0.9rem; opacity: 0.8; text-transform: uppercase; }

  /* Filtres */
  .centres-filters { background: #fff; padding: 2rem 0 1rem 0; border-bottom: 1px solid #e2e8f0; }
  .filter-buttons { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
  .filter-btn { padding: 0.7rem 1.5rem; border: 2px solid #e2e8f0; background: white; color: #2563eb; border-radius: 50px; font-weight: 600; transition: all 0.3s; cursor: pointer; text-decoration: none; }
  .filter-btn:hover, .filter-btn.active { background: #2563eb; color: white; border-color: #2563eb; transform: translateY(-2px); }

  /* Grille de centres */
  .centres-section { background: #f8fafc; padding: 3rem 0; }
  .centres-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 2rem; margin-top: 2rem; }
  .centre-card-modern { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; transition: all 0.3s; overflow: hidden; position: relative; }
  .centre-card-modern:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.13); }
  .centre-card-header { background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%); color: white; padding: 1.2rem 1.5rem; display: flex; align-items: center; gap: 1rem; }
  .centre-card-header i { font-size: 2rem; }
  .centre-card-title { font-size: 1.2rem; font-weight: 700; }
  .centre-card-body { padding: 1.5rem; }
  .centre-card-meta { font-size: 0.95rem; color: #64748b; margin-bottom: 0.7rem; }
  .centre-card-services { font-size: 0.98rem; margin-bottom: 0.7rem; }
  .centre-card-distance { display: inline-block; background: #10b981; color: white; border-radius: 12px; padding: 0.2rem 0.8rem; font-size: 0.9rem; margin-top: 0.5rem; }
  .centre-card-phone { color: #059669; font-weight: 600; }
  .centre-card-btns { margin-top: 1rem; display: flex; gap: 0.7rem; }
  .centre-btn { background: #2563eb; color: white; border: none; border-radius: 8px; padding: 0.6rem 1.2rem; font-weight: 600; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
  .centre-btn:hover { background: #0ea5e9; color: white; transform: translateY(-2px); }

  /* Audio & géoloc */
  .centres-tools { display: flex; justify-content: center; gap: 1.5rem; margin-top: 2rem; }
  .audio-btn, .near-btn { background: #10b981; color: white; border: none; border-radius: 50px; padding: 0.7rem 1.5rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
  .audio-btn:hover, .near-btn:hover { background: #059669; }
  
  /* Lecteur audio */
  .audio-player-container { display: flex; align-items: center; gap: 1rem; }
  .audio-controls { display: flex; align-items: center; gap: 0.5rem; }
  .audio-control-btn { background: #2563eb; color: white; border: none; border-radius: 8px; padding: 0.5rem 0.8rem; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
  .audio-control-btn:hover { background: #1d4ed8; transform: scale(1.05); }
  .audio-time { color: white; font-size: 0.9rem; font-weight: 600; min-width: 45px; text-align: center; }

  /* CTA */
  .centres-cta { background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 3rem 0; text-align: center; color: white; }
  .centres-cta h2 { font-size: 2.2rem; font-weight: 800; margin-bottom: 1rem; }
  .centres-cta p { font-size: 1.1rem; opacity: 0.9; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto; }
  .cta-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: white; color: #10b981; padding: 1rem 2rem; border-radius: 50px; text-decoration: none; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
  .cta-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); color: #059669; }

  @media (max-width: 768px) {
    .centres-hero h1 { font-size: 2rem; }
    .centres-stats { flex-direction: column; gap: 1.2rem; }
    .centres-grid { grid-template-columns: 1fr; gap: 1.2rem; }
    .centres-tools { flex-direction: column; gap: 1rem; }
  }
</style>
{% endblock %}

{% block content %}
<!-- Section Héros -->
<section class="centres-hero">
  <div class="container centres-hero-content">
    <h1><i class="fas fa-hospital-user"></i> Centres de santé</h1>
    <p>Retrouvez tous les centres médicaux, hôpitaux et cliniques proches de chez vous. Accédez à leurs coordonnées, services et localisez le centre le plus adapté à vos besoins.</p>
    <div class="centres-stats">
      <div>
        <span class="centres-stat-number">{{ all_centres|length }}+</span>
        <span class="centres-stat-label">Centres</span>
      </div>
      <div>
        <span class="centres-stat-number">24/7</span>
        <span class="centres-stat-label">Ouverts</span>
      </div>
      <div>
        <span class="centres-stat-number">100%</span>
        <span class="centres-stat-label">Gratuit</span>
      </div>
    </div>
    <div class="centres-tools">
      <button class="near-btn" id="near-me-btn"><i class="fa fa-map-marker-alt"></i> Centre le plus proche</button>
      
      <!-- Lecteur audio complet -->
      <div class="audio-player-container">
        <button class="audio-btn" id="centres-audio-btn" title="Écouter l'explication">
          <i class="fa fa-play" id="audio-icon"></i> 
          <span id="audio-text">Explication audio</span>
        </button>
        <div class="audio-controls" id="audio-controls" style="display: none;">
          <button class="audio-control-btn" id="pause-btn" title="Pause">
            <i class="fa fa-pause"></i>
          </button>
          <button class="audio-control-btn" id="stop-btn" title="Stop">
            <i class="fa fa-stop"></i>
          </button>
          <span class="audio-time" id="audio-time">00:00</span>
        </div>
        <audio id="centres-audio" src="{% static 'core/audio/centres_explain.mp3' %}"></audio>
      </div>
    </div>
  </div>
</section>

<!-- Filtres -->
<section class="centres-filters">
  <div class="container">
    <div class="filter-buttons">
      <button class="filter-btn active" data-type="all">Tous</button>
      <button class="filter-btn" data-type="HP">Hôpitaux</button>
      <button class="filter-btn" data-type="CL">Cliniques</button>
      <button class="filter-btn" data-type="UR">Urgences</button>
    </div>
  </div>
</section>

<!-- Grille de centres -->
<section class="centres-section">
  <div class="container">
    {% if nearest and user_location %}
      <!-- Centre le plus proche en évidence -->
      <div class="nearest-centre-highlight" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 2rem; border-radius: 20px; margin-bottom: 3rem; text-align: center;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-map-marker-alt"></i> Centre le plus proche de votre position</h3>
        <div class="nearest-centre-card" style="background: white; color: #1e293b; padding: 1.5rem; border-radius: 15px; display: inline-block; text-align: left; max-width: 500px;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <i class="fas fa-hospital-alt" style="font-size: 2rem; color: #10b981;"></i>
            <div>
              <h4 style="margin: 0; color: #1e293b;">{{ nearest.nom }}</h4>
              <span class="badge bg-success">{{ nearest.get_type_display }}</span>
            </div>
          </div>
          <div style="margin-bottom: 0.5rem;"><i class="fas fa-location-dot"></i> {{ nearest.adresse }}</div>
          <div style="margin-bottom: 0.5rem;"><strong>Services :</strong> {{ nearest.services }}</div>
          {% if nearest.telephone %}<div style="margin-bottom: 0.5rem;"><i class="fas fa-phone"></i> {{ nearest.telephone }}</div>{% endif %}
          <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            {% if nearest.telephone %}<a href="tel:{{ nearest.telephone }}" class="centre-btn" style="background: #10b981;"><i class="fas fa-phone"></i> Appeler</a>{% endif %}
            <a href="https://www.google.com/maps/search/?api=1&query={{ nearest.latitude }},{{ nearest.longitude }}" target="_blank" class="centre-btn" style="background: #10b981;"><i class="fas fa-map-marked-alt"></i> Itinéraire</a>
          </div>
        </div>
        <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.9;">
          <i class="fas fa-walking"></i> Distance : {{ nearest.distance|floatformat:1 }} km de votre position
        </div>
      </div>
    {% endif %}
    
    <h3 style="margin-bottom: 2rem; color: #1e293b; text-align: center;">
      {% if user_location %}
        <i class="fas fa-list"></i> Tous les centres (triés par distance)
      {% else %}
        <i class="fas fa-list"></i> Tous les centres
      {% endif %}
    </h3>
    
    <div class="centres-grid">
      {% for c in all_centres %}
      <div class="centre-card-modern" data-type="{{ c.type }}" {% if c.is_nearest %}style="border: 3px solid #10b981;"{% endif %}>
        <div class="centre-card-header">
          <i class="fas fa-hospital-alt"></i>
          <span class="centre-card-title">{{ c.nom }}</span>
          <span class="badge bg-light text-primary ms-2">{{ c.get_type_display }}</span>
          {% if c.is_nearest %}<span class="badge bg-success ms-2"><i class="fas fa-star"></i> Plus proche</span>{% endif %}
        </div>
        <div class="centre-card-body">
          <div class="centre-card-meta"><i class="fas fa-location-dot"></i> {{ c.adresse }}</div>
          <div class="centre-card-services"><strong>Services :</strong> {{ c.services }}</div>
          {% if c.telephone %}<div class="centre-card-phone"><i class="fas fa-phone"></i> {{ c.telephone }}</div>{% endif %}
          {% if c.distance %}<span class="centre-card-distance"><i class="fas fa-walking"></i> {{ c.distance|floatformat:1 }} km</span>{% endif %}
          <div class="centre-card-btns">
            {% if c.telephone %}<a href="tel:{{ c.telephone }}" class="centre-btn"><i class="fas fa-phone"></i> Appeler</a>{% endif %}
            <a href="https://www.google.com/maps/search/?api=1&query={{ c.latitude }},{{ c.longitude }}" target="_blank" class="centre-btn"><i class="fas fa-map-marked-alt"></i> Itinéraire</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- CTA -->
<section class="centres-cta">
  <div class="container">
    <h2>Besoin d’aide médicale ?</h2>
    <p>Utilisez notre assistant intelligent pour décrire vos symptômes et recevoir des conseils personnalisés ou trouvez le centre le plus adapté à votre situation.</p>
    <a href="{% url 'pipeline' %}" class="cta-btn"><i class="fas fa-stethoscope"></i> Consultation intelligente</a>
  </div>
</section>

<script>
// Lecteur audio complet
  const audio = document.getElementById('centres-audio');
  const audioBtn = document.getElementById('centres-audio-btn');
  const audioIcon = document.getElementById('audio-icon');
  const audioText = document.getElementById('audio-text');
  const audioControls = document.getElementById('audio-controls');
  const pauseBtn = document.getElementById('pause-btn');
  const stopBtn = document.getElementById('stop-btn');
  const audioTime = document.getElementById('audio-time');
  
  let isPlaying = false;
  
  // Fonction pour formater le temps
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  // Fonction pour mettre à jour l'affichage
  function updateAudioDisplay() {
    if (isPlaying) {
      audioIcon.className = 'fa fa-pause';
      audioText.textContent = 'Pause';
      audioControls.style.display = 'flex';
    } else {
      audioIcon.className = 'fa fa-play';
      audioText.textContent = 'Explication audio';
      audioControls.style.display = 'none';
    }
  }
  
  // Bouton principal play/pause
  audioBtn.onclick = function() {
    if (isPlaying) {
      audio.pause();
      isPlaying = false;
    } else {
      audio.play();
      isPlaying = true;
    }
    updateAudioDisplay();
  };
  
  // Bouton pause
  pauseBtn.onclick = function() {
    audio.pause();
    isPlaying = false;
    updateAudioDisplay();
  };
  
  // Bouton stop
  stopBtn.onclick = function() {
    audio.pause();
    audio.currentTime = 0;
    isPlaying = false;
    updateAudioDisplay();
  };
  
  // Mise à jour du temps
  audio.addEventListener('timeupdate', function() {
    audioTime.textContent = formatTime(audio.currentTime);
  });
  
  // Quand l'audio se termine
  audio.addEventListener('ended', function() {
    isPlaying = false;
    updateAudioDisplay();
  });
  
  // Gestion des erreurs
  audio.addEventListener('error', function() {
    alert('Erreur lors du chargement de l\'audio. Vérifiez que le fichier existe.');
  });
// Géolocalisation
  document.getElementById('near-me-btn').onclick = function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    // Afficher un message de chargement
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Localisation...';
    btn.disabled = true;
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        // Afficher un message de succès
        btn.innerHTML = '<i class="fas fa-check"></i> Trouvé !';
        btn.style.background = '#10b981';
        
        // Rediriger après un court délai
        setTimeout(function() {
          const url = new URL(window.location);
          url.searchParams.set('lat', pos.coords.latitude);
          url.searchParams.set('lon', pos.coords.longitude);
          window.location.href = url;
        }, 1000);
        
      }, function(err) {
        // Gérer les erreurs spécifiques
        let errorMessage = 'Erreur de géolocalisation.';
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMessage = 'Accès à la géolocalisation refusé. Veuillez autoriser l\'accès à votre position.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMessage = 'Impossible de déterminer votre position.';
            break;
          case err.TIMEOUT:
            errorMessage = 'Délai de géolocalisation dépassé.';
            break;
        }
        
        // Restaurer le bouton
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Afficher l'erreur
        alert(errorMessage);
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 60000
      });
    } else {
      alert('Géolocalisation non supportée par ce navigateur.');
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  };
// Filtres dynamiques
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.getAttribute('data-type');
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      document.querySelectorAll('.centre-card-modern').forEach(card => {
        if (type === 'all' || card.getAttribute('data-type') === type) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  });
</script>
{% endblock %}
